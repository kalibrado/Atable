(()=>{var B=Object.defineProperty;var Y=(c,e,t)=>e in c?B(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var C=(c,e)=>()=>(c&&(e=c(c=0)),e);var q=(c,e)=>{for(var t in e)B(c,t,{get:e[t],enumerable:!0})};var g=(c,e,t)=>Y(c,typeof e!="symbol"?e+"":e,t);var I,b,O,K,w,o,D=C(()=>{I={MEALS_URL:"/api/atable",SAVE_DELAY:1e3},b={CACHE:"atable-planner-cache",PENDING_SAVE:"atable-planner-pending-save"},O={MIDI:"midi",SOIR:"soir"},K={[O.MIDI]:"\u2600\uFE0F",[O.SOIR]:"\u{1F319}"},w={SAVED:"\u2713 Sauvegard\xE9",PENDING_OFFLINE:"\u{1F4BE} Sauvegarde en attente (hors ligne)",LOCAL_SAVE:"\u26A0\uFE0F Sauvegarde locale (erreur r\xE9seau)",SYNC_SUCCESS:"\u2713 Synchronisation r\xE9ussie",CONNECTION_RESTORED:"\u{1F310} Connexion r\xE9tablie",OFFLINE_MODE:"\u{1F4E1} Hors ligne - Les modifications seront synchronis\xE9es plus tard",CACHE_LOADED:"\u{1F4F1} Chargement depuis le cache local",LOGOUT_SUCCESS:"D\xE9connexion r\xE9ussie",NOTIFICATION_TIME_UPDATED:"\u23F0 Heure de notification mise \xE0 jour",NOTIFICATION_ENABLED:"\u{1F514} Notifications activ\xE9es",NOTIFICATION_DISABLED:"\u{1F515} Notifications d\xE9sactiv\xE9es",ERROR:"\u274C Une erreur s'est produite"},o={SUCCESS:"success",ERROR:"error",WARNING:"warning"}});var E,P=C(()=>{D();E=class{static saveToCache(e){try{console.log(e),localStorage.setItem(b.CACHE,JSON.stringify(e))}catch(t){console.error("Erreur sauvegarde cache:",t)}}static getFromCache(){try{let e=localStorage.getItem(b.CACHE);return e?JSON.parse(e):null}catch(e){return console.error("Erreur lecture cache:",e),null}}static savePendingData(e){try{localStorage.setItem(b.PENDING_SAVE,JSON.stringify(e))}catch(t){console.error("Erreur sauvegarde donn\xE9es en attente:",t)}}static getPendingData(){try{let e=localStorage.getItem(b.PENDING_SAVE);return e?JSON.parse(e):null}catch(e){return console.error("Erreur lecture donn\xE9es en attente:",e),null}}static clearPendingData(){try{localStorage.removeItem(b.PENDING_SAVE)}catch(e){console.error("Erreur suppression donn\xE9es en attente:",e)}}static clearAll(){try{localStorage.removeItem(b.CACHE),localStorage.removeItem(b.PENDING_SAVE)}catch(e){console.error("Erreur effacement cache:",e)}}}});var m,$=C(()=>{D();P();k();m=class{static async loadMeals(){try{let e=await fetch(I.MEALS_URL);if(!e.ok)throw new Error(`Erreur HTTP: ${e.status}`);let t=await e.json();return E.saveToCache(t),t}catch(e){console.error("Erreur chargement repas:",e);let t=E.getFromCache();if(t)return r.showStatus(w.CACHE_LOADED,o.WARNING),t;throw new Error("Impossible de charger les donn\xE9es")}}static async saveMeals(e){try{if(!navigator.onLine)return this._handleOfflineSave(e);let t=await fetch(I.MEALS_URL,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await t.json();if(!t.ok||s!=null&&s.error)throw new Error(`Erreur HTTP: ${t.status} ${s==null?void 0:s.error}`);return E.clearPendingData(),E.saveToCache(e),r.showStatus((s==null?void 0:s.message)||w.SAVED,o.SUCCESS),!0}catch(t){return console.error("Erreur sauvegarde:",t),r.showStatus(t,o.ERROR),this._handleOfflineSave(e)}}static _handleOfflineSave(e){return E.savePendingData(e),E.saveToCache(e),r.showStatus(navigator.onLine?w.LOCAL_SAVE:w.PENDING_OFFLINE,o.WARNING),!1}static async syncPendingData(){let e=E.getPendingData();if(!e||!navigator.onLine)return!1;try{return(await fetch(I.MEALS_URL,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok?(E.clearPendingData(),r.showStatus(w.SYNC_SUCCESS,o.SUCCESS),!0):!1}catch(t){return console.error("Erreur de synchronisation:",t),!1}}static async fetchUserInfo(){try{let e=await fetch("/auth/me");if(e.ok)return await e.json();if(e.status===401)return window.location.replace("/login"),null;throw new Error("Erreur r\xE9cup\xE9ration utilisateur")}catch(e){return console.error("Erreur r\xE9cup\xE9ration utilisateur:",e),null}}static async logout(){try{return(await fetch("/auth/logout",{method:"POST"})).ok?(E.clearAll(),!0):!1}catch(e){return console.error("Erreur d\xE9connexion:",e),!1}}static async updateSettings(e){try{if(!(await fetch("/api/notifications/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw new Error("Erreur serveur");return!0}catch(t){return console.error("Erreur mise \xE0 jour param\xE8tres:",t),!1}}static async fetchIngredients(){try{let e=await fetch("/api/preferences/ingredients");if(!e.ok)throw new Error(`Erreur HTTP: ${e.status}`);return await e.json()}catch(e){return console.error("Erreur chargement ingr\xE9dients:",e),{ingredients:{}}}}static async addIngredientItem(e,t){try{let s=encodeURIComponent(e),a=await fetch(`/api/preferences/ingredients/${s}/item`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({item:t})});if(!a.ok){let n=await a.json();throw new Error(n.error||"Erreur serveur")}return await a.json()}catch(s){throw console.error("Erreur ajout item:",s),s}}static async removeIngredientItem(e,t){try{let s=encodeURIComponent(e),a=await fetch(`/api/preferences/ingredients/${s}/item`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({item:t})});if(!a.ok){let n=await a.json();throw new Error(n.error||"Erreur serveur")}return await a.json()}catch(s){throw console.error("Erreur suppression item:",s),s}}static async updateCategoryRepas(e,t){try{let s=encodeURIComponent(e),a=await fetch(`/api/preferences/ingredients/${s}/repas`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok){let n=await a.json();throw new Error(n.error||"Erreur serveur")}return await a.json()}catch(s){throw console.error("Erreur mise \xE0 jour repas:",s),s}}static async generateMeals(e=!1){try{let t=await fetch("/api/generator/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({replaceAll:e})});if(!t.ok){let s=await t.json();throw new Error(s.error||"Erreur serveur")}return await t.json()}catch(t){throw console.error("Erreur g\xE9n\xE9ration repas:",t),t}}static async generateSingleMeal(e,t=new Set){try{let s=await fetch("/api/generator/generate-single",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mealType:e,usedMeals:Array.from(t)})});if(!s.ok){let a=await s.json();throw new Error(a.error||"Erreur serveur")}return await s.json()}catch(s){throw console.error("Erreur g\xE9n\xE9ration repas unique:",s),s}}}});var S,x,G=C(()=>{S=class{static getDaysInCurrentMonth(){let e=new Date;return new Date(e.getFullYear(),e.getMonth()+1,0).getDate()}static getCurrentDayOfMonth(){return new Date().getDate()}static getDayName(e){let t=new Date,s=new Date(t.getFullYear(),t.getMonth(),e);return["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"][s.getDay()]}static getCurrentMonthName(){return new Date().toLocaleDateString("fr-FR",{month:"long",year:"numeric"})}static calculateWeekRanges(e,t=4){let s=[],a=Math.floor(e/t),n=e%t,i=1;for(let d=1;d<=t;d++){let l=a+(d<=n?1:0),h=i,y=i+l-1;s.push({weekNumber:d,startDay:h,endDay:y,days:this.generateDaysList(h,y)}),i=y+1}return s}static generateDaysList(e,t){let s=[];for(let a=e;a<=t;a++)s.push(a);return s}static findWeekForDay(e){let t=this.getDaysInCurrentMonth(),s=this.calculateWeekRanges(t,4);for(let a of s)if(e>=a.startDay&&e<=a.endDay)return a.weekNumber;return 1}static getDaysForWeek(e){let t=this.getDaysInCurrentMonth(),a=this.calculateWeekRanges(t,4).find(n=>n.weekNumber===e);return a?a.days:[]}static formatDate(e){let t=new Date;return new Date(t.getFullYear(),t.getMonth(),e).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})}static formatWeekLabel(e,t=!1){let s=this.getDaysInCurrentMonth(),n=this.calculateWeekRanges(s,4).find(l=>l.weekNumber===e);if(!n)return`Semaine ${e}`;let i=new Date().toLocaleDateString("fr-FR",{month:"long"}),d=new Date().toLocaleDateString("fr-FR",{month:"short"});return t?`S.${e} (${n.startDay}-${n.endDay} ${d})`:`Semaine ${e} (${n.startDay}-${n.endDay} ${i})`}},x=class{static capitalize(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}static truncate(e,t=50){return!e||e.length<=t?e:e.substring(0,t)+"..."}}});var p,W=C(()=>{$();U();k();G();p=class{static getCurrentWeekNumber(){let e=S.getCurrentDayOfMonth();return S.findWeekForDay(e)}static initialize(e,t){this.state.numberOfWeeks=e,this.state.weeksData=t||{};let s=S.getDaysInCurrentMonth();this.state.weekRanges=S.calculateWeekRanges(s,e),this.state.currentWeek=this.getCurrentWeekNumber(),this.renderWeeksTabs()}static renderWeeksTabs(){let e=document.getElementById("weeks-tabs-container");if(!e)return;if(this.state.numberOfWeeks===1){e.style.display="none";return}e.style.display="flex";let t=[],s=window.innerWidth<=600;for(let a=1;a<=this.state.numberOfWeeks;a++){let n=a===this.state.currentWeek?"active":"",i=S.formatWeekLabel(a,s);t.push(`
                <button 
                    class="week-tab ${n}" 
                    data-week="${a}"
                    onclick="window.weeksHandlers.switchWeek(${a})"
                >
                    ${i}
                </button>
            `)}e.innerHTML=t.join("")}static async switchWeek(e){if(e<1||e>this.state.numberOfWeeks||e===this.state.currentWeek)return;this.state.currentWeek=e;let t=await fetch(`/api/atable/${e}`),s={};t.ok&&(s=await t.json()),r.getState().mealsData=s,this.renderWeeksTabs();let a=S.getDaysForWeek(e,this.state.numberOfWeeks);L.renderDaysForWeek(s,a),r.attachEventListeners()}static getAllWeeksData(){let e=r.getState().mealsData;return this.state.weeksData[`week${this.state.currentWeek}`]=e,this.state.weeksData}static async updateNumberOfWeeks(e){if(e<1||e>4)throw new Error("Le nombre de semaines doit \xEAtre entre 1 et 4");try{if(await this.saveAllWeeks(),!(await fetch("/api/preferences",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({numberOfWeeks:e})})).ok)throw new Error("Erreur lors de la mise \xE0 jour");window.location.reload()}catch(t){throw console.error("Erreur mise \xE0 jour nombre de semaines:",t),t}}static async saveAllWeeks(){let e=this.getAllWeeksData();await m.saveMeals(e)}static getCurrentWeek(){return this.state.currentWeek}static getNumberOfWeeks(){return this.state.numberOfWeeks}static getCurrentWeekDays(){return S.getDaysForWeek(this.state.currentWeek,this.state.numberOfWeeks)}static getWeekRanges(){return this.state.weekRanges}};g(p,"state",{numberOfWeeks:1,currentWeek:1,weeksData:{},weekRanges:[]})});var _={};q(_,{UIRenderer:()=>L});var L,U=C(()=>{D();G();W();L=class{static createMealSection(e,t,s){let a=K[t],n=x.capitalize(t),i=s[t]||"";return`
            <div class="atable-section">
                <div class="atable-header">
                    <label class="atable-label" for="${e}-${t}">
                        <span>${a}</span>
                        <span>${n}</span>
                    </label>
                    <button 
                        class="generate-meal-btn" 
                        onclick="window.generatorHandlers.generateSingleMeal(${e}, '${t}')"
                        title="G\xE9n\xE9rer un repas"
                        aria-label="G\xE9n\xE9rer un repas pour ${n}"
                    >
                        \u{1F3B2} G\xE9n\xE9rer
                    </button>
                </div>
                <textarea 
                    class="atable-textarea" 
                    id="${e}-${t}"
                    data-day="${e}"
                    data-atable="${t}"
                    placeholder="Ex: P\xE2tes carbonara, salade verte..."
                    rows="4"
                >${i}</textarea>
            </div>
        `}static createCalendarEmoji(e){let s=new Date().toLocaleString("fr-FR",{month:"short"});return{month:s,dayNumber:e,html:`
                <span class="calendar-emoji" aria-hidden="true">
                    <span class="cal-month">${s}</span>
                    <span class="cal-day">${e}</span>
                </span>
            `}}static createDayCard(e,t,s){let{html:a}=this.createCalendarEmoji(e),n=S.getCurrentDayOfMonth(),i=e===String(n),d=S.getDayName(e),l=x.capitalize(d);return`
            <div class="day-card ${s?"":i?"today":"collapsed"}" data-day="${e}">
                <div class="day-header">
                    <div class="day-title">
                        <h2>${a} ${l} ${e}</h2>
                        ${i?`<span class="today-badge">Aujourd'hui</span>`:""}
                    </div>
                    <span class="toggle-icon">\u25BC</span>
                </div>
                <div class="day-content">
                    ${this.createMealSection(e,O.MIDI,t)}
                    ${this.createMealSection(e,O.SOIR,t)}
                </div>
            </div>
        `}static renderDaysForWeek(e,t){let s=document.getElementById("days-container"),a=S.getCurrentDayOfMonth(),n=window.innerWidth>=768,i=Object.keys(e),d=Object.values(e),l=i.map(h=>this.createDayCard(h,d[i.indexOf(h)],n)).join("");s.innerHTML=l,!n&&t.includes(a)&&this.scrollToDay(a),this.attachCardClickEvents()}static renderAllDays(e){let t=p.getCurrentWeekDays();this.renderDaysForWeek(e,t)}static scrollToDay(e){setTimeout(()=>{let t=document.querySelector(`.day-card[data-day="${e}"]`);t&&t.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)}static attachCardClickEvents(){let e=document.querySelectorAll(".day-card");e.forEach(t=>{t.querySelector(".day-header").addEventListener("click",()=>{let a=!t.classList.contains("collapsed");window.innerWidth<768&&e.forEach(n=>n.classList.add("collapsed")),a||t.classList.remove("collapsed")})})}static displayUserName(e){let t=document.getElementById("name-user");t&&e&&(t.textContent=` - ${e}`);let s=document.querySelector("#name-user");if(!s)return;let a=window.innerWidth<=600;s.dataset.fullTitle||(s.dataset.fullTitle=s.textContent.trim()),s.textContent=a?s.dataset.fullTitle.split(" ").map(n=>n.charAt(0)).join("."):s.dataset.fullTitle}}});var z={};q(z,{UIManager:()=>r});var u,r,k=C(()=>{D();$();U();P();W();u=class u{static showStatus(e,t=o.SUCCESS){let s=document.getElementById("status-message");s&&(s.textContent=e,s.className=`status-message ${t} show`,clearTimeout(u.state.statusTimeout),u.state.statusTimeout=setTimeout(()=>s.classList.remove("show"),3e3))}static handleTextareaChange(e){let t=e.target,s=t.dataset.day,a=t.dataset.atable,n=t.value;u.state.mealsData[s]||(u.state.mealsData[s]={midi:"",soir:""}),u.state.mealsData[s][a]=n,u.scheduleSave()}static scheduleSave(){u.state.saveTimeout&&clearTimeout(u.state.saveTimeout),u.state.saveTimeout=setTimeout(async()=>{await p.saveAllWeeks()},I.SAVE_DELAY)}static attachEventListeners(){[...document.querySelectorAll(".atable-textarea"),...document.querySelectorAll("input")].forEach(t=>{t.className==="atable-textarea"&&t.addEventListener("input",u.handleTextareaChange),t.addEventListener("focus",s=>{s.target.parentElement.style.transform="scale(1.005)"}),t.addEventListener("blur",s=>{s.target.parentElement.style.transform="scale(1)"})})}static setupConnectivityListeners(){window.addEventListener("online",async()=>{u.showStatus("\u{1F310} Connexion r\xE9tablie",o.SUCCESS),await m.syncPendingData()}),window.addEventListener("offline",()=>{u.showStatus("\u{1F4E1} Hors ligne - Les modifications seront synchronis\xE9es plus tard",o.WARNING)})}static setupBeforeUnload(){window.addEventListener("beforeunload",()=>{if(u.state.saveTimeout){clearTimeout(u.state.saveTimeout);let e=p.getAllWeeksData();E.saveToCache(e);let t=localStorage.getItem("atable-planner-pending-save");if(t&&navigator.sendBeacon){let s=new Blob([t],{type:"application/json"});navigator.sendBeacon(I.MEALS_URL,s)}}})}static async loadAndRender(){try{let{weeks:e,numberOfWeeks:t}=await m.loadMeals();p.initialize(t,e),u.state.mealsData=e;let s=p.getCurrentWeekNumber();L.renderAllDays(u.state.mealsData[`week${s}`]),u.attachEventListeners(),await m.syncPendingData()}catch(e){console.error("Erreur chargement et rendu:",e),u.showStatus("Erreur de chargement des donn\xE9es",o.ERROR)}}static getState(){return u.state}};g(u,"state",{mealsData:{},saveTimeout:null,statusTimeout:null});r=u});k();$();k();D();W();$();k();D();var A=class{static async initialize(){try{let e=await m.fetchIngredients();this.state.ingredients=e.ingredients||{},this.state.categories=Object.keys(this.state.ingredients)}catch(e){console.error("Erreur initialisation ingr\xE9dients:",e),r.showStatus("Erreur lors du chargement des ingr\xE9dients",o.ERROR)}}static render(){let e=document.getElementById("ingredients-container");if(!e)return;if(Object.keys(this.state.ingredients).length===0){e.innerHTML=`<p class="empty-ingredients">Aucune cat\xE9gorie d'ingr\xE9dients disponible</p>`;return}let t=Object.entries(this.state.ingredients).map(([s,a])=>(this.state.collapsedCategories.add(s),this.renderCategory(s,a))).join("");e.innerHTML=t,this.attachEventListeners()}static renderCategory(e,t){var i,d;let a=this.state.collapsedCategories.has(e)?"collapsed":"",n=t.items&&t.items.length>0?t.items.map(l=>this.renderItem(e,l)).join(""):'<span class="empty-items">Aucun ingr\xE9dient ajout\xE9</span>';return`
            <div class="ingredient-category ${a}" data-category="${e}">
                <div class="category-header" onclick="window.ingredientsHandlers.toggleCategory('${e}')">
                    <span class="category-title">${e}</span>
                    <span class="category-toggle">\u25BC</span>
                </div>
                <div class="category-content">
                    <div class="repas-toggles">
                        <div class="repas-toggle">
                            <input 
                                type="checkbox" 
                                id="midi-${e}" 
                                ${(i=t.repas)!=null&&i.midi?"checked":""}
                                onchange="window.ingredientsHandlers.updateRepas('${e}', 'midi', this.checked)"
                            >
                            <label for="midi-${e}">\u2600\uFE0F Midi</label>
                        </div>
                        <div class="repas-toggle">
                            <input 
                                type="checkbox" 
                                id="soir-${e}" 
                                ${(d=t.repas)!=null&&d.soir?"checked":""}
                                onchange="window.ingredientsHandlers.updateRepas('${e}', 'soir', this.checked)"
                            >
                            <label for="soir-${e}">\u{1F319} Soir</label>
                        </div>
                    </div>
                    <div class="items-list" data-category-items="${e}">
                        ${n}
                    </div>
                    <div class="add-item-form">
                        <input 
                            type="text" 
                            class="add-item-input" 
                            placeholder="Ajouter un ingr\xE9dient..."
                            data-category="${e}"
                        >
                        <button 
                            class="add-item-btn" 
                            data-category-btn="${e}"
                        >
                            Ajouter
                        </button>
                    </div>
                </div>
            </div>
        `}static renderItem(e,t){let s=t.replace(/'/g,"\\'");return`
            <span class="item-tag" data-item="${s}" data-item-category="${e}">
                ${t}
                <button 
                    class="item-remove" 
                    onclick="window.ingredientsHandlers.removeItem('${e}', '${s}')"
                    aria-label="Supprimer ${t}"
                >
                    \xD7
                </button>
            </span>
        `}static toggleCategory(e){let t=document.querySelector(`.ingredient-category[data-category="${e}"]`);t&&(this.state.collapsedCategories.has(e)?(this.state.collapsedCategories.delete(e),t.classList.remove("collapsed")):(this.state.collapsedCategories.add(e),t.classList.add("collapsed")))}static filterAndHighlight(e,t){let s=document.querySelector(`.add-item-input[data-category="${e}"]`),a=document.querySelector(`.add-item-btn[data-category-btn="${e}"]`),n=document.querySelector(`.items-list[data-category-items="${e}"]`);if(!s||!a||!n)return;let i=t.trim().toLowerCase(),d=n.querySelectorAll(".item-tag");if(d.forEach(y=>{y.classList.remove("highlight-match","exact-match","hidden")}),s.classList.remove("has-exact-match"),a.disabled=!1,!i)return;let l=!1,h=!1;d.forEach(y=>{let F=y.getAttribute("data-item").toLowerCase();F===i?(y.classList.add("exact-match"),l=!0):F.includes(i)?(y.classList.add("highlight-match"),h=!0):y.classList.add("hidden")}),l?(s.classList.add("has-exact-match"),a.disabled=!0,a.textContent="Existe d\xE9j\xE0"):a.textContent="Ajouter"}static async addItem(e){var n;let t=document.querySelector(`.add-item-input[data-category="${e}"]`);if(!t)return;let s=t.value.trim();if(!s){r.showStatus("Veuillez saisir un ingr\xE9dient",o.WARNING);return}if((((n=this.state.ingredients[e])==null?void 0:n.items)||[]).some(i=>i.toLowerCase()===s.toLowerCase())){r.showStatus("Cet ingr\xE9dient existe d\xE9j\xE0",o.WARNING);return}try{(await m.addIngredientItem(e,s)).success&&(this.state.ingredients[e].items||(this.state.ingredients[e].items=[]),this.state.ingredients[e].items.includes(s)||this.state.ingredients[e].items.push(s),t.value="",this.renderItemsList(e),this.attachCategoryEventListeners(e),r.showStatus(`\u2713 ${s} ajout\xE9`,o.SUCCESS))}catch(i){console.error("Erreur ajout item:",i),r.showStatus("Erreur lors de l'ajout",o.ERROR)}}static async removeItem(e,t){try{(await m.removeIngredientItem(e,t)).success&&(this.state.ingredients[e].items&&(this.state.ingredients[e].items=this.state.ingredients[e].items.filter(a=>a!==t)),this.renderItemsList(e),this.attachCategoryEventListeners(e),r.showStatus(`\u2713 ${t} supprim\xE9`,o.SUCCESS))}catch(s){console.error("Erreur suppression item:",s),r.showStatus("Erreur lors de la suppression",o.ERROR)}}static async updateRepas(e,t,s){try{this.state.ingredients[e].repas||(this.state.ingredients[e].repas={midi:!0,soir:!0}),this.state.ingredients[e].repas[t]=s,(await m.updateCategoryRepas(e,this.state.ingredients[e].repas)).success&&r.showStatus("\u2713 Pr\xE9f\xE9rences mises \xE0 jour",o.SUCCESS)}catch(a){console.error("Erreur mise \xE0 jour repas:",a),r.showStatus("Erreur lors de la mise \xE0 jour",o.ERROR);let n=document.getElementById(`${t}-${e}`);n&&(n.checked=!s)}}static handleKeyPress(e,t){e.key==="Enter"&&(e.preventDefault(),this.addItem(t))}static renderItemsList(e){let t=document.querySelector(`.items-list[data-category-items="${e}"]`);if(!t)return;let s=this.state.ingredients[e],a=s.items&&s.items.length>0?s.items.map(n=>this.renderItem(e,n)).join(""):'<span class="empty-items">Aucun ingr\xE9dient ajout\xE9</span>';t.innerHTML=a}static attachCategoryEventListeners(e){let t=document.querySelector(`.add-item-input[data-category="${e}"]`),s=document.querySelector(`.add-item-btn[data-category-btn="${e}"]`);if(t){let a=t.cloneNode(!0);t.parentNode.replaceChild(a,t),a.addEventListener("input",n=>{this.filterAndHighlight(e,n.target.value)}),a.addEventListener("keypress",n=>{this.handleKeyPress(n,e)})}if(s){let a=s.cloneNode(!0);s.parentNode.replaceChild(a,s),a.addEventListener("click",()=>{this.addItem(e)})}}static attachEventListeners(){Object.keys(this.state.ingredients).forEach(e=>{this.attachCategoryEventListeners(e)})}static exposeHandlers(){window.ingredientsHandlers={toggleCategory:e=>this.toggleCategory(e),addItem:e=>this.addItem(e),removeItem:(e,t)=>this.removeItem(e,t),updateRepas:(e,t,s)=>this.updateRepas(e,t,s),handleKeyPress:(e,t)=>this.handleKeyPress(e,t)}}static getIngredients(){return this.state.ingredients}};g(A,"state",{ingredients:{},categories:[],collapsedCategories:new Set});var N=class{static initialize(){document.querySelectorAll(".settings-section").forEach(t=>{let s=t.dataset.section;s&&(t.classList.add("collapsed"),this.state.collapsedSections.add(s))}),this.attachEventListeners()}static attachEventListeners(){document.querySelectorAll(".settings-section-header").forEach(t=>{t.addEventListener("click",s=>{s.preventDefault();let a=t.closest(".settings-section");this.toggleSection(a)})})}static toggleSection(e){if(!e)return;let t=e.dataset.section;e.classList.contains("collapsed")?(e.classList.remove("collapsed"),this.state.collapsedSections.delete(t)):(e.classList.add("collapsed"),this.state.collapsedSections.add(t)),this.saveState()}static expandAll(){document.querySelectorAll(".settings-section").forEach(t=>{t.classList.remove("collapsed");let s=t.dataset.section;this.state.collapsedSections.delete(s)}),this.saveState()}static collapseAll(){document.querySelectorAll(".settings-section").forEach(t=>{t.classList.add("collapsed");let s=t.dataset.section;this.state.collapsedSections.add(s)}),this.saveState()}static saveState(){try{localStorage.setItem("atable-settings-accordion-state",JSON.stringify(Array.from(this.state.collapsedSections)))}catch(e){console.error("Erreur sauvegarde \xE9tat accord\xE9on:",e)}}static restoreState(){try{let e=localStorage.getItem("atable-settings-accordion-state");if(e){let t=JSON.parse(e);this.state.collapsedSections=new Set(t),document.querySelectorAll(".settings-section").forEach(a=>{let n=a.dataset.section;this.state.collapsedSections.has(n)?a.classList.add("collapsed"):a.classList.remove("collapsed")})}}catch(e){console.error("Erreur restauration \xE9tat accord\xE9on:",e)}}static exposeHandlers(){window.settingsAccordion={expandAll:()=>this.expandAll(),collapseAll:()=>this.collapseAll(),toggle:e=>{let t=document.querySelector(`.settings-section[data-section="${e}"]`);t&&this.toggleSection(t)}}}};g(N,"state",{collapsedSections:new Set});var T=class c{static async openModal(){var n;let e=document.getElementById("settings-modal");if(!e){console.warn("Modal de param\xE8tres non trouv\xE9e");return}e.classList.add("show");let t=p.getNumberOfWeeks(),s=document.getElementById("number-of-weeks");s&&(s.value=t,s.addEventListener("change",async i=>{await c.updateNumberOfWeeks(parseInt(i.target.value))})),(n=document.getElementById("notification-time"))==null||n.addEventListener("change",async()=>{await c.updateNotificationTime()}),await c.updateUI(),await A.initialize(),A.render();let a=document.getElementById("enable-notifications");a&&a.addEventListener("change",async()=>{await c.toggleNotifications()}),window.menuHandlers.close()}static async updateNumberOfWeeks(e){try{await p.updateNumberOfWeeks(e),r.showStatus(`Planification sur ${e} semaine(s) activ\xE9e`,o.SUCCESS)}catch(t){console.error("Erreur:",t),r.showStatus("Erreur lors de la mise \xE0 jour",o.ERROR)}}static closeModal(){let e=document.getElementById("settings-modal");e&&e.classList.remove("show")}static async updateUI(){var e,t,s;if(!window.notificationSystem){console.warn("Syst\xE8me de notifications non charg\xE9");return}try{let a=await m.fetchUserInfo(),n=document.getElementById("enable-notifications"),{hour:i,minute:d}=(e=a==null?void 0:a.notifications)==null?void 0:e.settings,l=document.getElementById("notification-time"),h=document.getElementById("time-setting");n&&(n.checked=(s=(t=a==null?void 0:a.notifications)==null?void 0:t.settings)==null?void 0:s.enabled),l&&(l.value=`${String(i).padStart(2,"0")}:${String(d).padStart(2,"0")}`),h&&(n.checked?(h.style.opacity="1",l.disabled=!1):(h.style.opacity="0.5",l.disabled=!0)),c.updatePermissionStatus()}catch(a){r.showStatus(`Erreur mise \xE0 jour UI: ${a}`,o.ERROR)}}static updatePermissionStatus(){var a;let e=document.getElementById("permission-status"),t=document.getElementById("permission-text");if(!e||!t)return;let s=(a=document.getElementById("enable-notifications"))==null?void 0:a.checked;if(!("Notification"in window)){r.showStatus("Notifications non support\xE9es",o.WARNING),e.className="permission-status denied",t.textContent="\u274C Navigateur non compatible";return}if(!s){e.className="permission-status default",t.textContent="\u26A0\uFE0F Activez les notifications";return}switch(Notification.permission){case"granted":e.className="permission-status granted",t.textContent="\u2705 Notifications autoris\xE9es";break;case"denied":e.className="permission-status denied",t.textContent="\u274C Notifications refus\xE9es";break;default:e.className="permission-status default",t.textContent="\u26A0\uFE0F Permission non accord\xE9e";break}}static async toggleNotifications(){let e=document.getElementById("enable-notifications");if(!e||!window.notificationSystem)return;let t=e.checked;if(t){let s=document.getElementById("notification-time"),[a,n]=s.value.split(":").map(Number);if(!await window.notificationSystem.subscribe({enabled:t,hour:a,minute:n})){e.checked=!1,r.showStatus("Impossible d'activer les notifications",o.ERROR);return}}else if(!await window.notificationSystem.unsubscribe()){e.checked=!0,r.showStatus(w.ERROR,o.ERROR);return}await c.updateUI(),r.showStatus(t?w.NOTIFICATION_ENABLED:w.NOTIFICATION_DISABLED,o.SUCCESS)}static async updateNotificationTime(){let e=document.getElementById("notification-time");if(!e||!window.notificationSystem)return;let[t,s]=e.value.split(":").map(Number);await m.updateSettings({hour:t,minute:s}),r.showStatus(w.NOTIFICATION_TIME_UPDATED,o.SUCCESS)}static async initialize(){if(!window.notificationSystem){r.showStatus("Syst\xE8me de notifications non disponible",o.WARNING);return}await window.notificationSystem.start(),A.exposeHandlers(),N.initialize();let e=document.getElementById("settings-modal");e&&e.classList.contains("show")&&await c.updateUI()}static setupModalEvents(){window.addEventListener("click",e=>{let t=document.getElementById("settings-modal");e.target===t&&c.closeModal()})}},j=class{static async handleLogout(){if(confirm("Voulez-vous vraiment vous d\xE9connecter ?"))try{await m.logout()?window.location.href="/login":r.showStatus("Erreur lors de la d\xE9connexion",o.ERROR)}catch(e){r.showStatus("Erreur de connexion au serveur",o.ERROR)}}static async loadUserInfo(){try{let{user:e}=await m.fetchUserInfo();if(e&&e.name){let{UIRenderer:t}=await Promise.resolve().then(()=>(U(),_));t.displayUserName(e.name)}}catch(e){r.showStatus(`Erreur: ${e}`,o.ERROR)}}},M=class{static async generateAllMeals(e=!1){if(confirm(e?"Voulez-vous remplacer TOUS les repas existants ?":"Voulez-vous g\xE9n\xE9rer automatiquement les repas pour les cases vides ?")){r.showStatus("\u{1F4BE} Sauvegarde en cours...",o.SUCCESS);try{await p.saveAllWeeks(),r.showStatus("\u{1F504} G\xE9n\xE9ration en cours...",o.SUCCESS);let s=await m.generateMeals(e);s.success&&(r.showStatus("\u2705 "+s.message,o.SUCCESS),setTimeout(()=>{window.location.reload()},1e3))}catch(s){console.error("Erreur g\xE9n\xE9ration:",s),r.showStatus(s.message||"Erreur lors de la g\xE9n\xE9ration",o.ERROR)}}}static async generateSingleMeal(e,t){let s=document.getElementById(`${e}-${t}`),a=document.querySelector(`.generate-meal-btn[onclick*="${e}"][onclick*="${t}"]`);if(!s){console.error(`Textarea non trouv\xE9e pour ${e} ${t}`);return}a&&(a.disabled=!0,a.classList.add("generating"),a.textContent="\u23F3 G\xE9n\xE9ration...");try{let n=r.getState().mealsData,i=new Set;Object.values(n).forEach(l=>{l.midi&&i.add(l.midi.trim().toLowerCase()),l.soir&&i.add(l.soir.trim().toLowerCase())});let d=await m.generateSingleMeal(t,i);if(d.success&&d.suggestion){if(i.has(d.suggestion.trim().toLowerCase())){let h=await m.generateSingleMeal(t,i);if(h.success&&h.suggestion&&!i.has(h.suggestion.trim().toLowerCase()))s.value=h.suggestion;else{r.showStatus("\u26A0\uFE0F Tous les repas disponibles sont d\xE9j\xE0 utilis\xE9s",o.WARNING);return}}else s.value=d.suggestion;let l=new Event("input",{bubbles:!0});s.dispatchEvent(l),r.showStatus(`\u2713 Repas g\xE9n\xE9r\xE9 pour ${e} ${t}`,o.SUCCESS)}else r.showStatus("Impossible de g\xE9n\xE9rer un repas",o.WARNING)}catch(n){console.error("Erreur g\xE9n\xE9ration:",n),r.showStatus(n.message||"Erreur lors de la g\xE9n\xE9ration",o.ERROR)}finally{a&&(a.disabled=!1,a.classList.remove("generating"),a.textContent="\u{1F3B2} G\xE9n\xE9rer")}}};var v=class{static initialize(){let e=this.getSavedTheme(),t=this.getSystemTheme(),s=e||t;this.applyTheme(s),this.updateToggle(),this.watchSystemTheme()}static getSavedTheme(){try{return localStorage.getItem(this.STORAGE_KEY)}catch(e){return console.error("Erreur lecture th\xE8me sauvegard\xE9:",e),null}}static getSystemTheme(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?this.THEMES.DARK:this.THEMES.LIGHT}static getCurrentTheme(){return document.documentElement.getAttribute("data-theme")||this.THEMES.LIGHT}static applyTheme(e){e===this.THEMES.DARK?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.removeAttribute("data-theme"),this.saveTheme(e),this.updateMetaThemeColor(e)}static toggle(){let t=this.getCurrentTheme()===this.THEMES.DARK?this.THEMES.LIGHT:this.THEMES.DARK;return this.applyTheme(t),this.updateToggle(),t}static saveTheme(e){try{localStorage.setItem(this.STORAGE_KEY,e)}catch(t){console.error("Erreur sauvegarde th\xE8me:",t)}}static updateToggle(){let e=document.getElementById("dark-mode");if(e){let t=this.getCurrentTheme()===this.THEMES.DARK;e.checked=t}}static setupToggleListener(){let e=document.getElementById("dark-mode");e&&e.addEventListener("change",t=>{let s=t.target.checked?this.THEMES.DARK:this.THEMES.LIGHT;this.applyTheme(s),this.showThemeChangeNotification(s)})}static showThemeChangeNotification(e){Promise.resolve().then(()=>(k(),z)).then(({UIManager:t})=>{let s=e===this.THEMES.DARK?"\u{1F319} Mode sombre activ\xE9":"\u2600\uFE0F Mode clair activ\xE9";t.showStatus(s,"success")})}static updateMetaThemeColor(e){let t=document.querySelector('meta[name="theme-color"]');t||(t=document.createElement("meta"),t.name="theme-color",document.head.appendChild(t));let s={[this.THEMES.LIGHT]:"#069494",[this.THEMES.DARK]:"#1e293b"};t.content=s[e]}static watchSystemTheme(){if(!window.matchMedia)return;window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",t=>{if(!this.getSavedTheme()){let a=t.matches?this.THEMES.DARK:this.THEMES.LIGHT;this.applyTheme(a),this.updateToggle()}})}static resetToSystemTheme(){try{localStorage.removeItem(this.STORAGE_KEY);let e=this.getSystemTheme();this.applyTheme(e),this.updateToggle()}catch(e){console.error("Erreur r\xE9initialisation th\xE8me:",e)}}static isDarkMode(){return this.getCurrentTheme()===this.THEMES.DARK}};g(v,"STORAGE_KEY","atable-theme-preference"),g(v,"THEMES",{LIGHT:"light",DARK:"dark"});W();var R=class c{static createModal(){let e=document.createElement("div");return e.className="modal show",e.innerHTML=`
      <div class="modal-content" style="width:600px;">
        <div class="modal-header">
          <h2 id="modal-title"></h2>
        </div>
        <form id="modal-form">
            <div class="modal-body " style="height: 80%; display:flex;">
                <input type="text" class="add-item-input" id="modal-input" placeholder="" />
            </div>
            <div class="modal-footer">
              <div class="settings-group">
                <div class="setting-group">
                  <button type="submit" class="btn-danger">Confirmer</button>
                </div>
                <div class="setting-group">
                  <button type="button" id="modal-btn-cancel" class="btn-primary">Annuler</button>
                </div>
              </div>
          </form>
        </div>
      </div>
    `,e.style.zIndex="110",document.body.appendChild(e),e}static showModal(e,t,s){let a=c.createModal(),n=document.getElementById("modal-title"),i=document.getElementById("modal-input"),d=document.getElementById("modal-form");n.textContent=e,i.placeholder=t,d.onsubmit=l=>{l.preventDefault();let h=document.getElementById("modal-input").value;s(h)},document.querySelector("#modal-btn-cancel").onclick=()=>{a.remove()}}static changePassword(e){c.showModal("Changer le mot de passe","Nouveau mot de passe",t=>{if(!t||t.length<8){alert("Le mot de passe doit contenir au moins 8 caract\xE8res");return}fetch(`/api/users/${e}/password`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t})}).then(()=>alert("Mot de passe modifi\xE9 avec succ\xE8s"))})}static changeEmail(e){c.showModal("Changer l'email","Nouvel email",t=>{if(!t||!t.includes("@")){alert("Format email invalide");return}fetch(`/api/users/${e}/email`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t})}).then(()=>alert("Email modifi\xE9 avec succ\xE8s"))})}static deleteAccount(e){confirm("\xCAtes-vous s\xFBr de vouloir supprimer votre compte ?")&&fetch(`/api/users/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json"}}).then(()=>alert("Compte supprim\xE9"))}};var f=class{static init(){var a;this.modal=document.getElementById("mobile-menu-modal");let e=document.getElementById("hamburger-btn"),t=(a=this.modal)==null?void 0:a.querySelector(".close-menu-btn");if(!this.modal||!e){console.warn("\xC9l\xE9ments du menu introuvables");return}e.addEventListener("click",()=>this.toggle()),t==null||t.addEventListener("click",()=>this.close());let s=this.modal.querySelector(".mobile-menu-content");s&&s.addEventListener("click",n=>{n.stopPropagation()}),this.modal.addEventListener("click",n=>{n.target===this.modal&&this.close()}),this.setupKeyboardNavigation(),this.updateFocusableElements()}static setupKeyboardNavigation(){document.addEventListener("keydown",e=>{if(this.isOpen)switch(e.key){case"Escape":this.close();break;case"Tab":this.handleTabKey(e);break}})}static handleTabKey(e){if(!this.focusableElements||this.focusableElements.length===0)return;let t=this.focusableElements[0],s=this.focusableElements[this.focusableElements.length-1];e.shiftKey?document.activeElement===t&&(e.preventDefault(),s.focus()):document.activeElement===s&&(e.preventDefault(),t.focus())}static updateFocusableElements(){if(!this.modal)return;let e='button:not([disabled]), [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';this.focusableElements=this.modal.querySelectorAll(e)}static toggle(){this.isOpen?this.close():this.open()}static open(){!this.modal||this.isOpen||(this.closeTimeout&&(clearTimeout(this.closeTimeout),this.closeTimeout=null),this.previousFocusElement=document.activeElement,this.modal.classList.remove("closing"),this.modal.classList.add("active"),this.isOpen=!0,document.body.style.overflow="hidden",setTimeout(()=>{var t;let e=(t=this.modal)==null?void 0:t.querySelector(".close-menu-btn");e==null||e.focus()},100),this.announceToScreenReader("Menu ouvert"))}static close(){!this.modal||!this.isOpen||(this.modal.classList.add("closing"),this.isOpen=!1,document.body.style.overflow="",this.previousFocusElement&&typeof this.previousFocusElement.focus=="function"&&this.previousFocusElement.focus(),this.announceToScreenReader("Menu ferm\xE9"),this.closeTimeout=setTimeout(()=>{this.modal.classList.remove("active","closing"),this.closeTimeout=null},300))}static announceToScreenReader(e){let t=document.createElement("div");t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),t.className="sr-only",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{document.body.removeChild(t)},1e3)}static isMenuOpen(){return this.isOpen}static forceClose(){this.modal&&(this.modal.classList.remove("active","closing"),this.isOpen=!1,document.body.style.overflow="",this.closeTimeout&&(clearTimeout(this.closeTimeout),this.closeTimeout=null))}};g(f,"modal",null),g(f,"isOpen",!1),g(f,"previousFocusElement",null),g(f,"focusableElements",null),g(f,"closeTimeout",null);window.toggleMobileMenu=function(){f.toggle()};var H=class{static async initialize(){try{v.initialize(),await j.loadUserInfo(),await r.loadAndRender(),await T.initialize(),r.setupConnectivityListeners(),r.setupBeforeUnload(),T.setupModalEvents(),N.exposeHandlers(),v.setupToggleListener(),f.init(),this.exposeGlobalHandlers()}catch(e){console.error("Erreur lors de l'initialisation:",e),r.showStatus("Erreur d'initialisation de l'application","error")}}static exposeGlobalHandlers(){window.openSettings=()=>T.openModal(),window.closeSettings=()=>T.closeModal(),window.toggleNotifications=()=>T.toggleNotifications(),window.updateNotificationTime=()=>T.updateNotificationTime(),window.handleLogout=()=>j.handleLogout(),window.themeHandlers={toggle:()=>v.toggle(),reset:()=>v.resetToSystemTheme(),isDark:()=>v.isDarkMode()},window.weeksHandlers={switchWeek:e=>p.switchWeek(e),updateNumberOfWeeks:e=>p.updateNumberOfWeeks(e)},window.generatorHandlers={generateFillEmpty:()=>M.generateAllMeals(!1),generateReplaceAll:()=>M.generateAllMeals(!0),showPreview:()=>M.showPreview(),generateSingleMeal:(e,t)=>M.generateSingleMeal(e,t)},window.userManager={changePassword:()=>R.changePassword(),changeEmail:()=>R.changeEmail(),deleteAccount:()=>R.deleteAccount()},window.menuHandlers={toggle:()=>f.toggle(),open:()=>f.open(),close:()=>f.close(),isOpen:()=>f.isMenuOpen()},window.toggleMobileMenu=()=>f.toggle()}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{H.initialize()}):H.initialize();})();
