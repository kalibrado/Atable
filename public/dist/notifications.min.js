(()=>{var a=null;async function u(){if(a)return a;try{return a=(await(await fetch("/api/notifications/vapid-public-key")).json()).publicKey,a}catch(r){return console.error("Erreur r\xE9cup\xE9ration cl\xE9 VAPID:",r),null}}function l(r){let n="=".repeat((4-r.length%4)%4),i=(r+n).replace(/\-/g,"+").replace(/_/g,"/"),e=window.atob(i),o=new Uint8Array(e.length);for(let t=0;t<e.length;++t)o[t]=e.charCodeAt(t);return o}async function s(){if(!("serviceWorker"in navigator))return console.warn("Service Workers non support\xE9s"),null;try{let r=await navigator.serviceWorker.register("/service-worker.js");return await navigator.serviceWorker.ready,r}catch(r){return console.error("Erreur Service Worker:",r),null}}async function d(){return"Notification"in window?Notification.permission==="granted"?!0:Notification.permission!=="denied"?await Notification.requestPermission()==="granted":!1:(console.warn("Notifications non support\xE9es"),!1)}async function f(r={}){try{if(!await d())throw new Error("Permission refus\xE9e");let i=await s();if(!i)throw new Error("Service Worker non disponible");let e=await u();if(!e)throw new Error("Cl\xE9 VAPID non disponible");let o=await i.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:l(e)}),t=await fetch("/api/notifications/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({permissionNotification:o,settings:{enabled:r.enabled!==void 0?r.enabled:!0,hour:r.hour||8,minute:r.minute||0}})}),c=await t.json();if(!t.ok)throw new Error("Erreur serveur lors de l'inscription");return c}catch(n){return console.error("Erreur abonnement push:",n),!1}}async function p(){try{let n=await(await navigator.serviceWorker.ready).pushManager.getSubscription();n&&await n.unsubscribe();let i=await fetch("/api/notifications/unsubscribe",{method:"DELETE"}),e=await i.json();if(!i.ok)throw new Error(e.error||"Erreur serveur lors de la d\xE9sinscription");return e}catch(r){return console.error("Erreur d\xE9sabonnement:",r),!1}}window.notificationSystem={subscribe:f,unsubscribe:p,start:async()=>await s()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",s):s();})();
